{% extends "base.html" %}
{% block title %}Delivery Note - SO {{ delivery.so_doc_num or 'None' }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Delivery Note</h1>
            <p class="text-muted mb-0">Sales Order: <strong>{{ delivery.so_doc_num or 'None' }}</strong></p>
        </div>
        <div>
            <a href="{{ url_for('sales_delivery.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            {% if delivery.status == 'draft' and delivery.items|length > 0 %}
            <button type="button" class="btn btn-success" onclick="submitDelivery()">
                <i class="fas fa-paper-plane"></i> Submit to SAP
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Status Alert -->
    {% if delivery.status == 'submitted' %}
    <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> Delivery Note successfully posted to SAP B1
        {% if delivery.sap_doc_num %}
            - Document Number: <strong>{{ delivery.sap_doc_num }}</strong>
        {% endif %}
    </div>
    {% endif %}

    <div class="row">
        <!-- Sales Order Details -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="breadcrumb-item active">Sales Order Details</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">Customer Code:</th>
                            <td>{{ delivery.card_code or so_data.CardCode or 'None' }}</td>
                        </tr>
                        <tr>
                            <th>Customer Name:</th>
                            <td>{{ delivery.card_name or so_data.CardName or 'None' }}</td>
                        </tr>
                        <tr>
                            <th>Document Number:</th>
                            <td>{{ delivery.so_doc_num or so_data.DocNum or 'None' }}</td>
                        </tr>
                        <tr>
                            <th>Currency:</th>
                            <td>{{ delivery.doc_currency or so_data.DocCurrency or 'INR' }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if delivery.status == 'draft' %}
                                    <span class="badge bg-warning">Draft</span>
                                {% elif delivery.status == 'submitted' %}
                                    <span class="badge bg-success">Submitted</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="breadcrumb-item active">Quick Actions</h6>
                </div>
                <div class="card-body">
                    {% if delivery.status == 'draft' %}
                    <button type="button" class="btn btn-primary btn-lg w-100 mb-3" onclick="openScanModal()">
                        <i class="fas fa-barcode"></i> Scan Barcode
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg w-100" data-bs-toggle="modal" data-bs-target="#addItemModal">
                        <i class="fas fa-plus"></i> Add Item Manually
                    </button>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        Delivery note has been submitted. No further changes allowed.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Picked Items -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="breadcrumb-item active">Picked Items</h6>
            <span class="badge bg-secondary">{{ delivery.items|length }} items</span>
        </div>
        <div class="card-body">
            {% if delivery.items %}
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th width="10%">Line</th>
                            <th width="15%">Item Code</th>
                            <th width="25%">Description</th>
                            <th width="8%">Qty</th>
                            <th width="10%">Warehouse</th>
                            <th width="12%">Batch/Serial</th>
                            <th width="10%">QR Code</th>
                            <th width="10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTable">
                        {% for item in delivery.items %}
                        <tr data-item-id="{{ item.id }}">
                            <td>{{ item.line_number }}</td>
                            <td><strong>{{ item.item_code }}</strong></td>
                            <td>{{ item.item_description }}</td>
                            <td class="text-center">{{ item.quantity }}</td>
                            <td>{{ item.warehouse_code }}</td>
                            <td>
                                {% if item.batch_number %}
                                    <span class="badge bg-info">Batch: {{ item.batch_number }}</span>
                                {% endif %}
                                {% if item.serial_number %}
                                    <span class="badge bg-primary">Serial: {{ item.serial_number }}</span>
                                {% endif %}
                                {% if item.serial_numbers %}
                                    {% for serial in item.serial_numbers %}
                                    <span class="badge bg-primary">{{ serial.internal_serial_number }}</span>
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if item.batch_number or item.serial_number or item.serial_numbers %}
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="generateQRCode('{{ item.id }}', '{{ item.item_code }}', '{{ item.batch_number or item.serial_number }}', '{{ item.warehouse_code }}')">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if delivery.status == 'draft' %}
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem({{ item.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle"></i> No items added yet. Scan barcodes or add items manually to begin.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Open Sales Order Lines -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="breadcrumb-item active">Available Sales Order Lines</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th width="8%">Line</th>
                            <th width="15%">Item Code</th>
                            <th width="30%">Description</th>
                            <th width="10%">Ordered</th>
                            <th width="10%">Open Qty</th>
                            <th width="10%">Warehouse</th>
                            <th width="10%">Unit Price</th>
                            <th width="10%">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in so_data.DocumentLines %}
                        <tr>
                            <td>{{ line.LineNum }}</td>
                            <td><strong>{{ line.ItemCode }}</strong></td>
                            <td>{{ line.ItemDescription }}</td>
                            <td class="text-center">{{ line.Quantity }}</td>
                            <td class="text-center">
                                <span class="badge bg-success">{{ line.RemainingOpenQuantity }}</span>
                            </td>
                            <td>{{ line.WarehouseCode }}</td>
                            <td class="text-end">{{ "%.2f"|format(line.UnitPrice) }}</td>
                            <td>
                                {% if delivery.status == 'draft' and line.RemainingOpenQuantity > 0 %}
                                <button type="button" class="btn btn-primary btn-sm" 
                                        onclick="openLineSerialEntry({{ line.LineNum }}, '{{ line.ItemCode }}', '{{ line.WarehouseCode }}', {{ line.RemainingOpenQuantity }}, '{{ line.ItemDescription }}')">
                                    <i class="fas fa-barcode"></i> Add Serials
                                </button>
                                {% elif line.RemainingOpenQuantity == 0 %}
                                <span class="badge bg-secondary">Closed</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Add Item to Delivery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="mb-3">
                        <label for="line_select" class="form-label">Select Sales Order Line <span class="text-danger">*</span></label>
                        <select class="form-select" id="line_select" required>
                            <option value="">Choose line...</option>
                            {% for line in so_data.DocumentLines %}
                            <option value="{{ line.LineNum }}" data-item="{{ line.ItemCode }}" data-open="{{ line.RemainingOpenQuantity }}">
                                Line {{ line.LineNum }}: {{ line.ItemCode }} - {{ line.ItemDescription }} (Open: {{ line.RemainingOpenQuantity }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="quantity" step="0.01" min="0.01" required>
                        <small class="form-text text-muted">Open Quantity: <span id="maxQty">0</span></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addItem()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Serial Number Selection Modal -->
<div class="modal fade" id="serialSelectionModal" tabindex="-1" aria-labelledby="serialSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serialSelectionModalLabel">Select Serial Numbers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Item:</strong> <span id="serialItemCode"></span></label>
                    <label class="form-label"><strong>Required Quantity:</strong> <span id="serialRequiredQty"></span></label>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Select serial numbers from the available list. You must select exactly <span id="serialQtyRequired"></span> serial number(s).
                </div>
                <div id="serialLoadingSpinner" class="text-center d-none">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                </div>
                <div id="serialErrorAlert" class="alert alert-danger d-none"></div>
                <div id="serialListContainer" class="d-none">
                    <label class="form-label">Available Serial Numbers:</label>
                    <div id="serialNumbersList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;"></div>
                    <div class="mt-3">
                        <label class="form-label">Selected Serial Numbers:</label>
                        <div id="selectedSerialsList" class="border rounded p-3 bg-light" style="min-height: 50px;">
                            <span class="text-muted">No serials selected yet</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSerialBtn" onclick="confirmSerialSelection()" disabled>
                    <i class="fas fa-check"></i> Confirm Selection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalLabel">QR Code Label</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer"></div>
                <div id="qrLabelInfo" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printQRCode()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Line Serial Entry Modal -->
<div class="modal fade" id="lineSerialEntryModal" tabindex="-1" aria-labelledby="lineSerialEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="lineSerialEntryModalLabel">
                    <i class="fas fa-barcode"></i> Enter Serial Numbers
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Item Code:</strong> <span id="lineSerialItemCode" class="text-primary"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Warehouse:</strong> <span id="lineSerialWarehouse" class="text-primary"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Item Description:</strong> <span id="lineSerialItemDesc"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Open Quantity:</strong> <span id="lineSerialOpenQty" class="badge bg-success"></span>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    Enter serial numbers below. Number of serials cannot exceed the open quantity.
                    Serials will be validated against SAP inventory.
                </div>
                
                <div class="mb-3">
                    <label for="serialInputText" class="form-label">Enter Serial Numbers (one per line or comma-separated):</label>
                    <textarea class="form-control" id="serialInputText" rows="6" 
                              placeholder="Enter serial numbers here...&#10;e.g.&#10;SN001&#10;SN002&#10;or SN001, SN002, SN003"></textarea>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="showAvailableInventorySerials()">
                            <i class="fas fa-list"></i> Show Available Serials
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-success w-100" onclick="validateEnteredSerials()">
                            <i class="fas fa-check-circle"></i> Validate Serials
                        </button>
                    </div>
                </div>
                
                <div id="inventorySerialsContainer" class="d-none mb-3">
                    <label class="form-label">Available Serials in SAP Inventory:</label>
                    <div id="inventorySerialsList" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                        <span class="text-muted">Loading...</span>
                    </div>
                    <small class="form-text text-muted">Click on a serial to add it to the input box above.</small>
                </div>
                
                <div id="validationResultContainer" class="d-none">
                    <label class="form-label">Validation Result:</label>
                    <div id="validationResult" class="border rounded p-3"></div>
                </div>
                
                <div id="lineSerialError" class="alert alert-danger d-none mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveLineSerialsBtn" onclick="saveLineSerials()">
                    <i class="fas fa-save"></i> Save Serials
                </button>
            </div>
        </div>
    </div>
</div>

<style>
#addItemModal, #qrModal, #serialSelectionModal, #lineSerialEntryModal { z-index: 9999 !important; }
.modal-backdrop { z-index: 9998 !important; }
.serial-item { padding: 8px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
.serial-item:hover { background-color: #f5f5f5; }
.serial-item.selected { background-color: #d4edda; border-color: #28a745; }
.serial-badge { display: inline-block; padding: 4px 8px; margin: 2px; background-color: #007bff; color: white; border-radius: 4px; font-size: 12px; }
.inventory-serial-item { display: inline-block; padding: 4px 8px; margin: 3px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; font-size: 12px; }
.inventory-serial-item:hover { background-color: #007bff; color: white; }
.validation-valid { color: green; }
.validation-invalid { color: red; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const deliveryId = {{ delivery.id }};
let currentSerialSelectionData = { delivery_item_id: null, base_line: null, item_code: null, required_quantity: 0, selected_serials: [] };
const addedQuantities = {};

{% for item in delivery.items %}
if (!addedQuantities[{{ item.base_line }}]) { addedQuantities[{{ item.base_line }}] = 0; }
addedQuantities[{{ item.base_line }}] += {{ item.quantity }};
{% endfor %}

document.addEventListener('DOMContentLoaded', function() {
    const lineSelect = document.getElementById('line_select');
    if (lineSelect) {
        lineSelect.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            const itemCode = selected.getAttribute('data-item');
            const baseLine = parseInt(this.value);
            const openQty = parseFloat(selected.getAttribute('data-open'));
            const alreadyAdded = addedQuantities[baseLine] || 0;
            const remainingQty = openQty - alreadyAdded;
            const maxQtyEl = document.getElementById('maxQty');
            const quantityEl = document.getElementById('quantity');
            if (maxQtyEl) maxQtyEl.textContent = remainingQty.toFixed(2);
            if (quantityEl) { quantityEl.max = remainingQty; quantityEl.value = remainingQty; }
        });
    }
});

function addItem() {
    const lineSelect = document.getElementById('line_select');
    if (!lineSelect) { console.error('Line select not found'); return; }
    const baseLine = parseInt(lineSelect.value);
    const itemCode = lineSelect.options[lineSelect.selectedIndex].getAttribute('data-item');
    const quantityEl = document.getElementById('quantity');
    const quantity = quantityEl ? parseFloat(quantityEl.value) : 0;
    if (isNaN(baseLine) || !quantity) { alert('Please fill all required fields'); return; }
    const openQty = parseFloat(lineSelect.options[lineSelect.selectedIndex].getAttribute('data-open'));
    const alreadyAdded = addedQuantities[baseLine] || 0;
    const remainingQty = openQty - alreadyAdded;
    if (quantity > remainingQty) { alert(`Cannot add ${quantity}. Only ${remainingQty.toFixed(2)} remaining.`); return; }
    
    fetch('{{ url_for("sales_delivery.api_validate_item") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_code: itemCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.serial_required && quantity > 0) {
            openSerialSelectionModal(baseLine, itemCode, quantity);
        } else {
            submitAddItem(baseLine, itemCode, quantity, '', '', []);
        }
    })
    .catch(error => { console.error('Error:', error); alert('Error validating item'); });
}

function openSerialSelectionModal(baseLine, itemCode, quantity) {
    currentSerialSelectionData = { delivery_item_id: null, base_line: baseLine, item_code: itemCode, required_quantity: quantity, selected_serials: [] };
    document.getElementById('serialItemCode').textContent = itemCode;
    document.getElementById('serialRequiredQty').textContent = quantity;
    document.getElementById('serialQtyRequired').textContent = quantity;
    document.getElementById('selectedSerialsList').innerHTML = '<span class="text-muted">No serials selected yet</span>';
    document.getElementById('confirmSerialBtn').disabled = true;
    loadAvailableSerials(baseLine);
    const modal = new bootstrap.Modal(document.getElementById('serialSelectionModal'));
    modal.show();
}

function loadAvailableSerials(baseLine) {
    const loadingSpinner = document.getElementById('serialLoadingSpinner');
    const errorAlert = document.getElementById('serialErrorAlert');
    const listContainer = document.getElementById('serialListContainer');
    loadingSpinner.classList.remove('d-none');
    errorAlert.classList.add('d-none');
    listContainer.classList.add('d-none');
    
    fetch('{{ url_for("sales_delivery.api_get_available_serials") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ delivery_id: deliveryId, base_line: baseLine })
    })
    .then(response => response.json())
    .then(data => {
        loadingSpinner.classList.add('d-none');
        if (!data.success) { errorAlert.textContent = data.error || 'Failed to load serials'; errorAlert.classList.remove('d-none'); return; }
        const serials = data.available_serials || [];
        const serialsList = document.getElementById('serialNumbersList');
        if (serials.length === 0) { errorAlert.textContent = 'No available serial numbers'; errorAlert.classList.remove('d-none'); return; }
        serialsList.innerHTML = '';
        serials.forEach(serial => {
            const serialDiv = document.createElement('div');
            serialDiv.className = 'serial-item';
            serialDiv.innerHTML = `<input type="checkbox" class="serial-checkbox" value="${serial.internal_serial_number}" onchange="updateSerialSelection()"> <strong>${serial.internal_serial_number}</strong>`;
            serialDiv.onclick = function(e) { if (e.target.tagName !== 'INPUT') { const checkbox = serialDiv.querySelector('input[type="checkbox"]'); checkbox.checked = !checkbox.checked; updateSerialSelection(); } };
            serialsList.appendChild(serialDiv);
        });
        listContainer.classList.remove('d-none');
    })
    .catch(error => { console.error('Error:', error); loadingSpinner.classList.add('d-none'); errorAlert.textContent = 'Error loading serials: ' + error.message; errorAlert.classList.remove('d-none'); });
}

function updateSerialSelection() {
    const checkboxes = document.querySelectorAll('.serial-checkbox:checked');
    currentSerialSelectionData.selected_serials = Array.from(checkboxes).map(cb => cb.value);
    const selectedList = document.getElementById('selectedSerialsList');
    if (currentSerialSelectionData.selected_serials.length === 0) {
        selectedList.innerHTML = '<span class="text-muted">No serials selected yet</span>';
    } else {
        selectedList.innerHTML = currentSerialSelectionData.selected_serials.map(serial => `<span class="serial-badge">${serial}</span>`).join('');
    }
    const confirmBtn = document.getElementById('confirmSerialBtn');
    confirmBtn.disabled = currentSerialSelectionData.selected_serials.length !== currentSerialSelectionData.required_quantity;
    document.querySelectorAll('.serial-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox.checked) { item.classList.add('selected'); } else { item.classList.remove('selected'); }
    });
}

function confirmSerialSelection() {
    const baseLine = currentSerialSelectionData.base_line;
    const itemCode = currentSerialSelectionData.item_code;
    const quantity = currentSerialSelectionData.required_quantity;
    const serials = currentSerialSelectionData.selected_serials;
    
    fetch('{{ url_for("sales_delivery.api_validate_serial_allocation") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ delivery_id: deliveryId, base_line: baseLine, serial_numbers: serials, quantity: quantity })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) { alert('Serial validation failed: ' + data.error); return; }
        const modal = bootstrap.Modal.getInstance(document.getElementById('serialSelectionModal'));
        modal.hide();
        submitAddItem(baseLine, itemCode, quantity, '', '', serials);
    })
    .catch(error => { console.error('Error:', error); alert('Error validating serials: ' + error.message); });
}

function submitAddItem(baseLine, itemCode, quantity, batchNumber, serialNumber, serials = []) {
    const data = { delivery_id: deliveryId, base_line: baseLine, item_code: itemCode, quantity: quantity, batch_number: batchNumber, serial_number: serialNumber, serial_numbers: serials };
    fetch('{{ url_for("sales_delivery.api_add_item") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (serials.length > 0) { allocateSerials(data.item_id, serials); } else { location.reload(); }
        } else { alert('Error: ' + data.error); }
    })
    .catch(error => { alert('Error adding item: ' + error); });
}

function allocateSerials(itemId, serials) {
    fetch('{{ url_for("sales_delivery.api_allocate_serials") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ delivery_item_id: itemId, serial_numbers: serials })
    })
    .then(response => response.json())
    .then(data => { if (data.success) { location.reload(); } else { alert('Error: ' + data.error); } })
    .catch(error => { alert('Error: ' + error); });
}

function deleteItem(itemId) {
    if (!confirm('Delete this item?')) return;
    fetch(`{{ url_for("sales_delivery.api_delete_item", item_id=0) }}`.replace('0', itemId), { method: 'DELETE' })
    .then(response => response.json())
    .then(data => { if (data.success) { location.reload(); } else { alert('Error: ' + data.error); } });
}

function generateQRCode(itemId, itemCode, batchSerial, warehouse) {
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = '';
    const qrData = `DELIVERY:${itemCode}-${batchSerial}`;
    new QRCode(qrContainer, { text: qrData, width: 256, height: 256 });
    const labelInfo = document.getElementById('qrLabelInfo');
    labelInfo.innerHTML = `<p><strong>Item:</strong> ${itemCode}</p><p><strong>Serial:</strong> ${batchSerial}</p><p><strong>Warehouse:</strong> ${warehouse}</p>`;
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
}

function printQRCode() { window.print(); }

function submitDelivery() {
    if (!confirm('Submit delivery to SAP B1?')) return;
    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    fetch('{{ url_for("sales_delivery.api_post_delivery_to_sap") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ delivery_id: deliveryId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) { alert('Success: ' + data.message); location.reload(); } else { alert('Error: ' + data.error); submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit to SAP'; }
    })
    .catch(error => { alert('Error: ' + error); submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit to SAP'; });
}

let currentLineSerialData = { base_line: null, item_code: null, warehouse_code: null, open_quantity: 0, item_description: '' };

function openLineSerialEntry(baseLine, itemCode, warehouseCode, openQty, itemDesc) {
    currentLineSerialData = {
        base_line: baseLine,
        item_code: itemCode,
        warehouse_code: warehouseCode,
        open_quantity: openQty,
        item_description: itemDesc
    };
    
    document.getElementById('lineSerialItemCode').textContent = itemCode;
    document.getElementById('lineSerialWarehouse').textContent = warehouseCode;
    document.getElementById('lineSerialItemDesc').textContent = itemDesc;
    document.getElementById('lineSerialOpenQty').textContent = openQty;
    document.getElementById('serialInputText').value = '';
    document.getElementById('inventorySerialsContainer').classList.add('d-none');
    document.getElementById('validationResultContainer').classList.add('d-none');
    document.getElementById('lineSerialError').classList.add('d-none');
    
    fetch('{{ url_for("sales_delivery.api_get_line_serials") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ delivery_id: deliveryId, base_line: baseLine })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.serial_numbers.length > 0) {
            const existingSerials = data.serial_numbers.map(s => s.internal_serial_number).join('\n');
            document.getElementById('serialInputText').value = existingSerials;
        }
    })
    .catch(error => console.log('Error loading existing serials:', error));
    
    const modal = new bootstrap.Modal(document.getElementById('lineSerialEntryModal'));
    modal.show();
}

function showAvailableInventorySerials() {
    const container = document.getElementById('inventorySerialsContainer');
    const list = document.getElementById('inventorySerialsList');
    
    container.classList.remove('d-none');
    list.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</div>';
    
    fetch('{{ url_for("sales_delivery.api_get_inventory_serials") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            item_code: currentLineSerialData.item_code,
            warehouse_code: currentLineSerialData.warehouse_code
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.serial_numbers && data.serial_numbers.length > 0) {
            list.innerHTML = '';
            data.serial_numbers.forEach(serial => {
                const span = document.createElement('span');
                span.className = 'inventory-serial-item';
                span.textContent = serial.internal_serial_number;
                span.onclick = function() { addSerialToInput(serial.internal_serial_number); };
                list.appendChild(span);
            });
        } else {
            list.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> No available serials found in SAP inventory for this item/warehouse.</span>';
        }
    })
    .catch(error => {
        list.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> Error loading serials: ' + error.message + '</span>';
    });
}

function addSerialToInput(serialNumber) {
    const textarea = document.getElementById('serialInputText');
    const currentValue = textarea.value.trim();
    if (currentValue) {
        const lines = currentValue.split('\n').map(s => s.trim()).filter(s => s);
        if (!lines.includes(serialNumber)) {
            textarea.value = currentValue + '\n' + serialNumber;
        }
    } else {
        textarea.value = serialNumber;
    }
}

function parseSerialInput() {
    const input = document.getElementById('serialInputText').value;
    let serials = [];
    input.split(/[\n,;]/).forEach(s => {
        const trimmed = s.trim();
        if (trimmed && !serials.includes(trimmed)) {
            serials.push(trimmed);
        }
    });
    return serials;
}

function validateEnteredSerials() {
    const serials = parseSerialInput();
    const resultContainer = document.getElementById('validationResultContainer');
    const resultDiv = document.getElementById('validationResult');
    const errorDiv = document.getElementById('lineSerialError');
    
    errorDiv.classList.add('d-none');
    resultContainer.classList.remove('d-none');
    resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Validating...</div>';
    
    if (serials.length === 0) {
        resultDiv.innerHTML = '<span class="text-warning">No serial numbers entered.</span>';
        return;
    }
    
    if (serials.length > currentLineSerialData.open_quantity) {
        resultDiv.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> Error: ${serials.length} serials entered but open quantity is only ${currentLineSerialData.open_quantity}.</span>`;
        return;
    }
    
    let validationPromises = serials.map(serial => {
        return fetch('{{ url_for("sales_delivery.api_validate_serial_availability") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                serial_number: serial,
                item_code: currentLineSerialData.item_code,
                warehouse_code: currentLineSerialData.warehouse_code
            })
        })
        .then(response => response.json())
        .then(data => ({ serial: serial, result: data }))
        .catch(error => ({ serial: serial, result: { success: false, error: error.message } }));
    });
    
    Promise.all(validationPromises).then(results => {
        let html = '<ul class="list-unstyled mb-0">';
        let allValid = true;
        
        results.forEach(r => {
            if (r.result.available) {
                html += `<li class="validation-valid"><i class="fas fa-check-circle"></i> ${r.serial} - Available</li>`;
            } else {
                html += `<li class="validation-invalid"><i class="fas fa-times-circle"></i> ${r.serial} - ${r.result.error || 'Not available'}</li>`;
                allValid = false;
            }
        });
        
        html += '</ul>';
        
        if (allValid) {
            html = '<div class="alert alert-success mb-2"><i class="fas fa-check"></i> All ' + serials.length + ' serials validated successfully!</div>' + html;
        } else {
            html = '<div class="alert alert-warning mb-2"><i class="fas fa-exclamation-triangle"></i> Some serials are invalid or unavailable.</div>' + html;
        }
        
        resultDiv.innerHTML = html;
    });
}

function saveLineSerials() {
    const serials = parseSerialInput();
    const errorDiv = document.getElementById('lineSerialError');
    const saveBtn = document.getElementById('saveLineSerialsBtn');
    
    errorDiv.classList.add('d-none');
    
    if (serials.length === 0) {
        errorDiv.textContent = 'Please enter at least one serial number.';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    if (serials.length > currentLineSerialData.open_quantity) {
        errorDiv.textContent = `Cannot save ${serials.length} serials. Open quantity is only ${currentLineSerialData.open_quantity}.`;
        errorDiv.classList.remove('d-none');
        return;
    }
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    fetch('{{ url_for("sales_delivery.api_save_line_serials") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            delivery_id: deliveryId,
            base_line: currentLineSerialData.base_line,
            item_code: currentLineSerialData.item_code,
            warehouse_code: currentLineSerialData.warehouse_code,
            serial_numbers: serials,
            open_quantity: currentLineSerialData.open_quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Serials';
        
        if (data.success) {
            alert('Serial numbers saved successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('lineSerialEntryModal'));
            modal.hide();
            location.reload();
        } else {
            errorDiv.textContent = data.error || 'Failed to save serials.';
            errorDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Serials';
        errorDiv.textContent = 'Error saving serials: ' + error.message;
        errorDiv.classList.remove('d-none');
    });
}
</script>
{% endblock %}
